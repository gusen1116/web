<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wa gusan - Magazine</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/magazine.css') }}">
</head>
<body>

    <!-- 고정 헤더 -->
    <nav id="main-nav" class="main-nav">
        <div class="nav-inner">
            <a href="{{ url_for('main.index') }}" class="logo font-myeongjo">Wagusen</a>
            <button id="menu-toggle-button" class="menu-toggle-button" aria-label="메인 메뉴 열기">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- 풀스크린 메뉴 -->
    <div id="fullscreen-menu" class="fullscreen-menu">
        <div class="menu-container">
            <div class="search-bar">
                <input type="text" placeholder="검색어 입력" class="search-input">
            </div>

            <div id="menu-grid" class="menu-grid">
                <!-- 메인 메뉴 -->
                <div class="main-menu-column">
                    <ul class="main-menu-list">
                        <li class="main-menu-item"><a href="{{ url_for('posts.index') }}">블로그</a></li>
                        <li class="main-menu-item"><a href="{{ url_for('gallery.index') }}">갤러리</a></li>
                        <li class="main-menu-item"><a href="{{ url_for('speedtest.speedtest_page') }}">네트워크</a></li>
                        <li class="main-menu-item"><a href="{{ url_for('main.about') }}">소개</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    {% if posts_with_colors %}
        <header class="hero-section">
                {% if current_page == 1 %}
                <div class="hero-logo-area">
                    <img src="https://placehold.co/400x150/030712/FFFFFF?text=WAGUSEN" alt="Wa gusan Logo" decoding="async">
                </div>
            {% endif %}
            <div class="hero-post-area{% if current_page > 1 %} hero-post-area--wide{% endif %}">
                {% set hero_data = posts_with_colors[0] %}
                {% set hero_post = hero_data.post %}
                {% set hero_preview = hero_post.get_rich_preview(100) %}
                <a href="{{ hero_post.get_url() }}" class="card-link">
                        <div class="card">
                            <div class="card-image">
                                {% if hero_preview['image_filename'] %}
                                <img src="{{ url_for('static', filename='images/posts/' + hero_preview['image_filename']) }}" alt="{{ hero_preview['image_alt'] }}" decoding="async" fetchpriority="high">
                                {% else %}
                                <img src="https://placehold.co/600x400/1f2937/a3e635?text=W" alt="Placeholder image" decoding="async" fetchpriority="high">
                            {% endif %}
                        </div>
                        <div class="card-content">
                            <h2 class="font-myeongjo">{{ hero_post.title }}</h2>
                            <p class="description">{{ hero_preview.text }}</p>
                            <p class="date">{{ hero_post.date.strftime('%Y-%m-%d') }}</p>
                        </div>
                    </div>
                </a>
            </div>
        </header>

        {% set remaining_posts = posts_with_colors[1:] %}
        {% if remaining_posts %}
            {% for post_chunk in remaining_posts | batch(3) %}
                <section class="content-section{% if loop.first %} first-section{% endif %}">
                    <div class="content-grid{% if loop.index is even %} reverse{% endif %}">
                        <div class="content-column" data-column-color="{{ post_chunk[0].color if post_chunk[0] else '#FFFFFF' }}">
                            {% for post_data in post_chunk %}
                                {% if loop.index != 3 and post_data %}
                                    {% set post = post_data.post %}
                                    {% set preview = post.get_rich_preview(80) %}
                                    <a href="{{ post.get_url() }}" class="card animate-on-scroll">
                                        <div class="card-image">
                                            {% if preview['image_filename'] %}
                                                <img src="{{ url_for('static', filename='images/posts/' + preview['image_filename']) }}" alt="{{ preview['image_alt'] }}" loading="lazy" decoding="async">
                                            {% else %}
                                                <img src="https://placehold.co/600x400/e2e8f0/333333?text={{ loop.index }}" alt="Placeholder image" loading="lazy" decoding="async">
                                            {% endif %}
                                        </div>
                                        <div class="card-content">
                                            <h3 class="font-myeongjo">{{ post.title }}</h3>
                                            <p class="description">{{ preview.text }}</p>
                                            <p class="date">{{ post.date.strftime('%Y-%m-%d') }}</p>
                                        </div>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% set sticky_color = (post_chunk[2].color if post_chunk|length > 2 and post_chunk[2] else (post_chunk[0].color if post_chunk[0] else '#FFFFFF')) %}
                        <div class="sticky-column" data-sticky-color="{{ sticky_color }}">
                            {% if post_chunk[2] %}
                                {% set post_data = post_chunk[2] %}
                                {% set post = post_data.post %}
                                {% set preview = post.get_rich_preview(120) %}
                                <div class="sticky-card-wrapper">
                                    <a href="{{ post.get_url() }}" class="card animate-on-scroll">
                                        <div class="card-image">
                                            {% if preview['image_filename'] %}
                                                <img src="{{ url_for('static', filename='images/posts/' + preview['image_filename']) }}" alt="{{ preview['image_alt'] }}" loading="lazy" decoding="async">
                                            {% else %}
                                                <img src="https://placehold.co/600x800/e2e8f0/333333?text=3" alt="Placeholder image" loading="lazy" decoding="async">
                                            {% endif %}
                                        </div>
                                        <div class="card-content">
                                            <h3 class="font-myeongjo">{{ post.title }}</h3>
                                            <p class="description">{{ preview.text }}</p>
                                            <p class="date">{{ post.date.strftime('%Y-%m-%d') }}</p>
                                        </div>
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </section>
            {% endfor %}
        {% endif %}

        {% if total_pages > 1 %}
            <div class="pagination">
                {% if current_page > 1 %}
                    <a href="{{ url_for('main.magazine', page=current_page - 1) }}">이전</a>
                {% else %}
                    <a href="#" class="disabled">이전</a>
                {% endif %}

                {% for page_num in range(1, total_pages + 1) %}
                    <a href="{{ url_for('main.magazine', page=page_num) }}" class="{{ 'active' if page_num == current_page else '' }}">{{ page_num }}</a>
                {% endfor %}

                {% if current_page < total_pages %}
                    <a href="{{ url_for('main.magazine', page=current_page + 1) }}">다음</a>
                {% else %}
                    <a href="#" class="disabled">다음</a>
                {% endif %}
            </div>
        {% endif %}

    {% else %}
        <div class="pagination-container">
            <h2 class="font-myeongjo">포스트가 없습니다.</h2>
            <p>표시할 포스트가 없습니다. 새 포스트를 추가해주세요.</p>
        </div>
    {% endif %}

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <p>&copy; 2025 | 와구센</p>
                    <a href="#" class="footer-logo">
                        <img src="{{ url_for('static', filename='images/site/footer-logo.gif') }}" alt="푸터 로고" loading="lazy">
                    </a>
                </div>
                <div class="footer-links">
                    <a href="https://github.com/wagusen" target="_blank" rel="noopener noreferrer">
                        <i class="fab fa-github footer-icon-github"></i>
                        <span>GitHub</span>
                    </a>
                    <a href="mailto:gusen@wagusen.com">
                        <i class="fas fa-envelope footer-icon-mail"></i>
                        <span>메일</span>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const nav = document.getElementById('main-nav');
        const bodyElement = document.body;
        const reduceMotion = window.matchMedia ? window.matchMedia('(prefers-reduced-motion: reduce)').matches : false;

        if (nav) {
            let lastScrollTop = 0;
            const getThresholds = () => {
                const navHeight = nav.offsetHeight || 0;
                return {
                    hideThreshold: navHeight * 1.4,
                    classThreshold: navHeight * 0.6,
                };
            };
            let { hideThreshold, classThreshold } = getThresholds();

            const updateNavState = (scrollTop) => {
                const isScrollingDown = scrollTop > lastScrollTop;
                const shouldHide = isScrollingDown && scrollTop > hideThreshold;

                nav.style.transform = shouldHide ? 'translateY(-110%)' : 'translateY(0)';

                bodyElement.classList.toggle('nav-is-scrolled', scrollTop > classThreshold);
                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            };

            updateNavState(window.pageYOffset || document.documentElement.scrollTop);

            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                updateNavState(scrollTop);
            }, { passive: true });

            window.addEventListener('resize', () => {
                ({ hideThreshold, classThreshold } = getThresholds());
                updateNavState(window.pageYOffset || document.documentElement.scrollTop);
            });
        }

        const menuToggle = document.getElementById('menu-toggle-button');
        const fullscreenMenu = document.getElementById('fullscreen-menu');
        const animatedElements = document.querySelectorAll('.animate-on-scroll');

        if (animatedElements.length) {
            if (reduceMotion) {
                animatedElements.forEach(target => target.classList.add('is-visible'));
            } else if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries, obs) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            obs.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.12 });

                animatedElements.forEach(target => observer.observe(target));
            } else {
                animatedElements.forEach(target => target.classList.add('is-visible'));
            }
        }

        const setMenuState = (shouldOpen) => {
            if (!fullscreenMenu || !menuToggle) return;
            fullscreenMenu.classList.toggle('active', shouldOpen);
            bodyElement.classList.toggle('overflow-hidden', shouldOpen);
            menuToggle.classList.toggle('is-active', shouldOpen);
            menuToggle.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
        };

        if (menuToggle && fullscreenMenu) {
            menuToggle.setAttribute('aria-expanded', 'false');

            menuToggle.addEventListener('click', () => {
                const willOpen = !fullscreenMenu.classList.contains('active');
                setMenuState(willOpen);
            });

            fullscreenMenu.addEventListener('click', (event) => {
                if (event.target === fullscreenMenu) {
                    setMenuState(false);
                }
            });

            fullscreenMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => setMenuState(false));
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && fullscreenMenu.classList.contains('active')) {
                    setMenuState(false);
                }
            });
        }

        document.querySelectorAll('[data-column-color]').forEach(column => {
            const color = column.getAttribute('data-column-color');
            if (color) {
                column.style.setProperty('--column-color', color);
            }
        });

        document.querySelectorAll('[data-sticky-color]').forEach(section => {
            const color = section.getAttribute('data-sticky-color');
            if (color) {
                section.style.setProperty('--sticky-color', color);
            }
        });
    </script>
</body>
</html>
