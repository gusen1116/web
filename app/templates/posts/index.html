{% extends "base.html" %}

{% block title %}블로그 - 와구센{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/blog-grid.css') }}">
{% endblock %}

{% block content %}
<div class="main-content">
    <!-- 포스트 타이틀 -->
    <h1>블로그</h1>
    
    <!-- 최신 포스트 그리드 -->
    <div class="posts-grid" id="postsGrid">
        {% for post in posts[:4] %}
            <article class="post-card" onclick="window.location.href='{{ url_for('posts.view_by_slug', slug=post.id) }}'">
                <div class="post-card-header">
                    <h2 class="post-card-title">
                        <a href="{{ url_for('posts.view_by_slug', slug=post.id) }}">{{ post.title }}</a>
                    </h2>
                    <div class="post-card-meta">
                        <div class="post-card-date">
                            <i class="far fa-calendar-alt"></i>
                            <span>{{ post.date.strftime('%Y년 %m월 %d일') }}</span>
                        </div>
                    </div>
                </div>
                <div class="post-card-content">
                    <div class="post-card-preview">
                        {{ post.get_preview(200) }}
                    </div>
                </div>
                <div class="post-card-footer">
                    <div class="post-card-tags">
                        {% for tag in post.tags[:2] %}
                            <a href="{{ url_for('posts.filter_by_tag', tag=tag) }}" class="post-card-tag">{{ tag }}</a>
                        {% endfor %}
                        {% if post.tags|length > 2 %}
                            <span class="post-card-tag">+{{ post.tags|length - 2 }}</span>
                        {% endif %}
                    </div>
                </div>
            </article>
        {% else %}
            <div class="empty-state">
                <p>포스트가 없습니다.</p>
            </div>
        {% endfor %}
    </div>
    
    <!-- 태그 및 필터 섹션 -->
    <div class="blog-widgets">
        <!-- 태그 필터 위젯 -->
        <div class="blog-widget">
            <h3 class="blog-widget-title">태그</h3>
            <div class="tag-filters">
                {% for tag in tags %}
                    <a href="#" class="tag-filter" data-tag="{{ tag.name }}">
                        {{ tag.name }} ({{ tag.count }})
                    </a>
                {% endfor %}
            </div>
        </div>
        
        <!-- 필터 보기 및 더 로드하기 -->
        <div class="blog-widget">
            <h3 class="blog-widget-title">포스트 더 보기</h3>
            <button id="loadMoreBtn" class="show-all-btn">
                <i class="fas fa-plus-circle"></i> 더 많은 포스트 보기
            </button>
        </div>
    </div>
    
    <!-- 추가 포스트가 로드될 영역 -->
    <div class="posts-grid hidden" id="additionalPosts">
        {% for post in posts[4:] %}
            <article class="post-card">
                <div class="post-card-header">
                    <h2 class="post-card-title">
                        <a href="{{ url_for('posts.view_by_slug', slug=post.id) }}">{{ post.title }}</a>
                    </h2>
                    <div class="post-card-meta">
                        <div class="post-card-date">
                            <i class="far fa-calendar-alt"></i>
                            <span>{{ post.date.strftime('%Y년 %m월 %d일') }}</span>
                        </div>
                    </div>
                </div>
                <div class="post-card-content">
                    <div class="post-card-preview">
                        {{ post.get_preview(200) }}
                    </div>
                </div>
                <div class="post-card-footer">
                    <div class="post-card-tags">
                        {% for tag in post.tags[:2] %}
                            <a href="{{ url_for('posts.filter_by_tag', tag=tag) }}" class="post-card-tag">{{ tag }}</a>
                        {% endfor %}
                        {% if post.tags|length > 2 %}
                            <span class="post-card-tag">+{{ post.tags|length - 2 }}</span>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('posts.view_by_slug', slug=post.id) }}" class="post-card-read-more">
                        더 읽기 <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </article>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 더 많은 포스트 로드 버튼
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const additionalPosts = document.getElementById('additionalPosts');
        
        if (loadMoreBtn && additionalPosts) {
            loadMoreBtn.addEventListener('click', function() {
                additionalPosts.classList.toggle('hidden');
                if (additionalPosts.classList.contains('hidden')) {
                    loadMoreBtn.innerHTML = '<i class="fas fa-plus-circle"></i> 더 많은 포스트 보기';
                } else {
                    loadMoreBtn.innerHTML = '<i class="fas fa-minus-circle"></i> 포스트 접기';
                }
            });
        }
        
        // 태그 필터링
        const tagFilters = document.querySelectorAll('.tag-filter');
        const allPosts = [...document.querySelectorAll('#postsGrid .post-card'), ...document.querySelectorAll('#additionalPosts .post-card')];
        let activeTag = null;
        
        tagFilters.forEach(filter => {
            filter.addEventListener('click', function(e) {
                e.preventDefault();
                const tag = this.getAttribute('data-tag');
                
                // 이미 활성화된 태그 클릭시 필터 제거
                if (activeTag === tag) {
                    activeTag = null;
                    tagFilters.forEach(f => f.classList.remove('active'));
                    allPosts.forEach(post => post.style.display = '');
                    return;
                }
                
                // 새 태그 필터 적용
                activeTag = tag;
                tagFilters.forEach(f => {
                    if (f.getAttribute('data-tag') === tag) {
                        f.classList.add('active');
                    } else {
                        f.classList.remove('active');
                    }
                });
                
                // 포스트 필터링
                let visiblePosts = 0;
                allPosts.forEach(post => {
                    const postTags = Array.from(post.querySelectorAll('.post-card-tag'))
                        .map(t => t.textContent.trim())
                        .filter(t => !t.startsWith('+'));
                        
                    if (postTags.includes(tag)) {
                        post.style.display = '';
                        visiblePosts++;
                    } else {
                        post.style.display = 'none';
                    }
                });
                
                // 모든 포스트가 필터링되었는지 확인
                if (visiblePosts === 0) {
                    // 필터 초기화
                    activeTag = null;
                    tagFilters.forEach(f => f.classList.remove('active'));
                    allPosts.forEach(post => post.style.display = '');
                    alert('선택한 태그의 게시물이 없습니다.');
                }
                
                // 추가 포스트 표시
                additionalPosts.classList.remove('hidden');
                loadMoreBtn.innerHTML = '<i class="fas fa-minus-circle"></i> 포스트 접기';
            });
        });
    });
</script>
{% endblock %}