{% extends "base.html" %}

{% block title %}블로그 - 와구센{% endblock %}

{% block description %}와구센의 개발 블로그. 프로그래밍, 웹 개발, 물리 시뮬레이션에 관한 글을 공유합니다.{% endblock %}

{% block head %}
<!-- 성능 최적화: 중요 리소스 프리로드 -->
<link rel="preload" href="{{ url_for('static', filename='css/pages.css') }}" as="style">

<!-- SEO 최적화 -->
<link rel="canonical" href="{{ request.url }}">
<meta name="robots" content="index, follow">

<!-- 구조화된 데이터 - 원본 기능 보존하면서 SEO 개선 -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Blog",
    "name": "와구센 블로그",
    "description": "프로그래밍과 기술에 대한 블로그",
    "url": "{{ request.url }}",
    "author": {
        "@type": "Person",
        "name": "와구센"
    },
    "blogPost": [
        {% for post in posts[:5] %}
        {
            "@type": "BlogPosting",
            "headline": "{{ post.title|e }}",
            "description": "{{ post.get_preview(160)|e }}",
            "url": "{{ url_for('posts.view_by_slug', slug=post.slug or post.id, _external=True) }}",
            "datePublished": "{{ post.date.isoformat() }}",
            "author": {
                "@type": "Person",
                "name": "{{ post.author|e }}"
            }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
{% endblock %}

{% block content %}
<!-- 블로그 헤더 - 원본 구조 유지, 접근성만 개선 -->
<header class="blog-header" role="banner">
    <h1 id="blog-main-title">블로그</h1>
</header>

<!-- 상단 태그 네비게이션 - 원본 기능 보존, 접근성 개선 -->
<nav class="top-tag-navigation" 
     role="navigation" 
     aria-labelledby="tag-navigation-title">
    <h2 id="tag-navigation-title" class="sr-only">태그별 필터링</h2>
    
    {% for tag in tags %}
        <button class="tag-item" 
                data-tag="{{ tag.name }}"
                role="button"
                aria-pressed="false"
                title="{{ tag.name }} 태그로 필터링하기">
            {{ tag.name }}
        </button>
    {% endfor %}
    
    <!-- 필터 상태 알림 (스크린 리더용) -->
    <div aria-live="polite" 
         aria-atomic="true" 
         class="sr-only" 
         id="filter-announcement"></div>
</nav>

<!-- 포스트 컨테이너 - 원본 구조 완전 보존 -->
<div class="posts-container">
    <!-- 포스트 그리드 - 접근성 개선 -->
    <section class="posts-grid" 
             id="initialPosts"
             role="region"
             aria-labelledby="blog-main-title"
             aria-describedby="posts-description">
        
        <p id="posts-description" class="sr-only">
            블로그 포스트 목록입니다. 태그를 클릭하여 필터링할 수 있습니다.
        </p>
        
        {% if posts %}
            {% for post in posts[:6] %}
                <article class="post-card fade-in" 
                         data-tags="{{ ','.join(post.tags) }}"
                         itemscope 
                         itemtype="https://schema.org/BlogPosting">
                    
                    <a href="{{ url_for('posts.view_by_slug', slug=post.slug or post.id) }}" 
                       class="post-card-link"
                       aria-labelledby="post-title-{{ loop.index }}"
                       aria-describedby="post-preview-{{ loop.index }}">
                        
                        <header class="post-card-header">
                            <h2 class="post-card-title" 
                                id="post-title-{{ loop.index }}"
                                itemprop="headline">
                                {{ post.title }}
                            </h2>
                            <div class="post-card-meta">
                                <div class="post-card-date">
                                    <time datetime="{{ post.date.isoformat() }}" 
                                          itemprop="datePublished"
                                          aria-label="작성일 {{ post.date.strftime('%Y년 %m월 %d일') }}">
                                        {{ post.date.strftime('%Y년 %m월 %d일') }}
                                    </time>
                                </div>
                            </div>
                        </header>
                        
                        <div class="post-card-content">
                            <div class="post-card-preview" 
                                 id="post-preview-{{ loop.index }}"
                                 itemprop="description">
                                {{ post.get_preview(150) }}
                            </div>
                        </div>
                        
                        <footer class="post-card-footer">
                            <div class="post-card-tags"
                                 {% if not post.tags %}aria-hidden="true"{% endif %}>
                                {% for tag in post.tags[:2] %}
                                    <span class="post-card-tag" itemprop="keywords">{{ tag }}</span>
                                {% endfor %}
                                {% if post.tags|length > 2 %}
                                    <span class="post-card-tag" 
                                          aria-label="추가 태그 {{ post.tags|length - 2 }}개">
                                        +{{ post.tags|length - 2 }}
                                    </span>
                                {% endif %}
                            </div>
                        </footer>
                    </a>
                </article>
            {% endfor %}
        {% else %}
            <!-- 빈 상태 - 접근성 개선 -->
            <div class="empty-state" role="status" aria-live="polite">
                <p>아직 게시글이 없습니다.</p>
            </div>
        {% endif %}
    </section>
    
    <!-- 추가 포스트 (더보기 누를 때 표시됨) - 원본 구조 보존 -->
    <section class="posts-grid hidden" 
             id="additionalPosts"
             role="region"
             aria-label="추가 포스트">
        {% for post in posts[6:] %}
            <article class="post-card fade-in" 
                     data-tags="{{ ','.join(post.tags) }}"
                     itemscope 
                     itemtype="https://schema.org/BlogPosting">
                
                <a href="{{ url_for('posts.view_by_slug', slug=post.slug or post.id) }}" 
                   class="post-card-link"
                   aria-labelledby="post-title-additional-{{ loop.index }}"
                   aria-describedby="post-preview-additional-{{ loop.index }}">
                    
                    <header class="post-card-header">
                        <h2 class="post-card-title" 
                            id="post-title-additional-{{ loop.index }}"
                            itemprop="headline">
                            {{ post.title }}
                        </h2>
                        <div class="post-card-meta">
                            <div class="post-card-date">
                                <time datetime="{{ post.date.isoformat() }}" 
                                      itemprop="datePublished">
                                    {{ post.date.strftime('%Y년 %m월 %d일') }}
                                </time>
                            </div>
                        </div>
                    </header>
                    
                    <div class="post-card-content">
                        <div class="post-card-preview" 
                             id="post-preview-additional-{{ loop.index }}"
                             itemprop="description">
                            {{ post.get_preview(150) }}
                        </div>
                    </div>
                    
                    <footer class="post-card-footer">
                        <div class="post-card-tags">
                            {% for tag in post.tags[:2] %}
                                <span class="post-card-tag" itemprop="keywords">{{ tag }}</span>
                            {% endfor %}
                            {% if post.tags|length > 2 %}
                                <span class="post-card-tag">+{{ post.tags|length - 2 }}</span>
                            {% endif %}
                        </div>
                    </footer>
                </a>
            </article>
        {% endfor %}
    </section>
    
    <!-- 더보기/접기 버튼 - 원본 기능 보존, 접근성 개선 -->
    {% if posts and posts|length > 6 %}
        <div class="toggle-button-container">
            <button id="toggleButton" 
                    class="toggle-button"
                    aria-expanded="false"
                    aria-controls="additionalPosts"
                    aria-describedby="toggle-help">
                <span>더 많은 포스트 보기</span>
                <i class="fas fa-chevron-down" aria-hidden="true"></i>
            </button>
            <div id="toggle-help" class="sr-only">
                클릭하면 추가 {{ posts|length - 6 }}개의 포스트를 표시하거나 숨깁니다
            </div>
        </div>
    {% endif %}
</div>

<!-- 성능 최적화: 접근성 지원 스타일만 추가 -->
<style>
/* 접근성 전용 스타일 - 원본 디자인 보존 */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* 포커스 개선 - 기존 스타일과 조화 */
.tag-item:focus,
.toggle-button:focus,
.post-card-link:focus {
    outline: 2px solid var(--primary-500);
    outline-offset: 2px;
    border-radius: 4px;
}

/* 고대비 모드 지원 */
@media (prefers-contrast: high) {
    .tag-item:focus,
    .toggle-button:focus,
    .post-card-link:focus {
        outline: 3px solid;
        outline-color: Highlight;
    }
}

/* 애니메이션 감소 설정 존중 */
@media (prefers-reduced-motion: reduce) {
    .fade-in,
    .post-card,
    .tag-item,
    .toggle-button {
        transition: none;
        animation: none;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ===== 원본 기능 완전 보존 =====
        
        // 더보기/접기 토글 기능 - 접근성만 개선
        const toggleButton = document.getElementById('toggleButton');
        const additionalPosts = document.getElementById('additionalPosts');
        
        if (toggleButton && additionalPosts) {
            toggleButton.addEventListener('click', function() {
                const isHidden = additionalPosts.classList.contains('hidden');
                
                additionalPosts.classList.toggle('hidden');
                
                // 접근성 속성 업데이트
                toggleButton.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
                
                if (isHidden) {
                    toggleButton.innerHTML = '<span>포스트 접기</span><i class="fas fa-chevron-up" aria-hidden="true"></i>';
                    // 스크린 리더에게 알림
                    announceToScreenReader('추가 포스트를 표시했습니다.');
                } else {
                    toggleButton.innerHTML = '<span>더 많은 포스트 보기</span><i class="fas fa-chevron-down" aria-hidden="true"></i>';
                    announceToScreenReader('추가 포스트를 숨겼습니다.');
                }
            });
        }
        
        // 태그 필터링 기능 - 원본 로직 보존, 접근성만 개선
        const tagItems = document.querySelectorAll('.tag-item');
        const postCards = document.querySelectorAll('.post-card-link');
        const filterAnnouncement = document.getElementById('filter-announcement');
        let activeTag = null;
        
        tagItems.forEach(tag => {
            tag.addEventListener('click', function() {
                const selectedTag = this.textContent.trim();
                
                // 같은 태그 재클릭 시 필터 해제 (원본 로직 보존)
                if (activeTag === selectedTag) {
                    activeTag = null;
                    tagItems.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-pressed', 'false');
                    });
                    
                    postCards.forEach(post => {
                        post.style.display = '';
                    });
                    
                    announceToScreenReader('모든 포스트를 표시합니다.');
                    return;
                }
                
                // 태그 활성화 상태 업데이트 (접근성 개선)
                activeTag = selectedTag;
                tagItems.forEach(t => {
                    const isSelected = t.textContent.trim() === selectedTag;
                    if (isSelected) {
                        t.classList.add('active');
                        t.setAttribute('aria-pressed', 'true');
                    } else {
                        t.classList.remove('active');
                        t.setAttribute('aria-pressed', 'false');
                    }
                });
                
                // 포스트 필터링 (원본 로직 보존)
                let visibleCount = 0;
                postCards.forEach(post => {
                    const postTags = post.getAttribute('data-tags').split(',');
                    
                    if (postTags.includes(selectedTag)) {
                        post.style.display = '';
                        visibleCount++;
                    } else {
                        post.style.display = 'none';
                    }
                });
                
                // 태그 필터링 시 추가 포스트도 보이게 함 (원본 로직 보존)
                if (additionalPosts) {
                    additionalPosts.classList.remove('hidden');
                    
                    if (toggleButton) {
                        toggleButton.innerHTML = '<span>포스트 접기</span><i class="fas fa-chevron-up" aria-hidden="true"></i>';
                        toggleButton.setAttribute('aria-expanded', 'true');
                    }
                }
                
                // 접근성: 필터 결과 안내
                if (visibleCount === 0) {
                    alert('선택한 태그의 게시물이 없습니다.');
                    // 필터 초기화 (원본 로직 보존)
                    activeTag = null;
                    tagItems.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-pressed', 'false');
                    });
                    
                    postCards.forEach(post => {
                        post.style.display = '';
                    });
                    
                    announceToScreenReader('모든 포스트를 표시합니다.');
                } else {
                    announceToScreenReader(`${selectedTag} 태그로 필터링했습니다. ${visibleCount}개의 포스트를 표시하고 있습니다.`);
                }
            });
            
            // 키보드 네비게이션 지원 추가
            tag.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
        
        // 스크린 리더 알림 함수
        function announceToScreenReader(message) {
            if (filterAnnouncement) {
                filterAnnouncement.textContent = message;
                // 잠시 후 메시지 제거 (중복 방지)
                setTimeout(() => {
                    filterAnnouncement.textContent = '';
                }, 1000);
            }
        }
        
        // 성능 최적화: 지연 로딩 구현
        if ('IntersectionObserver' in window) {
            const lazyImages = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        img.classList.add('fade-in');
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px'
            });
            
            lazyImages.forEach(img => imageObserver.observe(img));
        }
        
        // 접근성: 포커스 관리 개선
        document.addEventListener('keydown', function(e) {
            // ESC 키로 필터 초기화
            if (e.key === 'Escape' && activeTag) {
                activeTag = null;
                tagItems.forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-pressed', 'false');
                });
                
                postCards.forEach(post => {
                    post.style.display = '';
                });
                
                announceToScreenReader('필터를 초기화했습니다. 모든 포스트를 표시합니다.');
            }
        });
    });
</script>
{% endblock %}