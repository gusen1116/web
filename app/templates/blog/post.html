{% extends "base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block head %}
<!-- 코드 하이라이팅 추가 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism.min.css">
{% endblock %}

{% block content %}
<article class="post-detail">
    <header class="post-header">
        <h1 class="post-title">{{ post.title }}</h1>
        
        <div class="post-meta">
            {% if post.author %}
                <span class="author">{{ post.author.username }}</span>
            {% endif %}
            <span class="date">{{ post.created_at.strftime('%Y년 %m월 %d일') }}</span>
            {% if post.category %}
                <a href="{{ url_for('blog.index') }}?category={{ post.category.id }}" class="category">{{ post.category.name }}</a>
            {% endif %}
        </div>
        
        {% if post.tags %}
            <div class="tags-container">
                {% for tag in post.tags %}
                    <a href="{{ url_for('blog.index') }}?tag={{ tag.id }}" class="tag">{{ tag.name }}</a>
                {% endfor %}
            </div>
        {% endif %}
    </header>
    
    <div class="post-content">
        <script>
            // 포스트 콘텐츠를 JSON으로 파싱
            try {
                const contentString = {{ post.content|tojson }};
                let contentObj;
                
                try {
                    // 먼저 문자열을 JSON으로 파싱 시도
                    contentObj = JSON.parse(contentString);
                } catch (parseError) {
                    // 파싱 실패시, 전체 문자열을 단일 텍스트 블록으로 처리
                    contentObj = {
                        blocks: [{
                            type: 'paragraph',
                            content: contentString
                        }]
                    };
                }
                
                // 각 블록 유형에 맞게 HTML 생성
                let html = '';
                if (contentObj && contentObj.blocks) {
                    contentObj.blocks.forEach(block => {
                        switch(block.type) {
                            case 'paragraph':
                                html += `<p>${block.content}</p>`;
                                break;
                            case 'header':
                                const level = Math.min(Math.max(block.level, 1), 6);
                                html += `<h${level}>${block.content}</h${level}>`;
                                break;
                            case 'quote':
                                html += `<blockquote>${block.content}</blockquote>`;
                                break;
                            case 'code':
                                html += `<pre><code class="language-${block.language || 'plaintext'}">${block.content}</code></pre>`;
                                break;
                            case 'list':
                                const listTag = block.style === 'ordered' ? 'ol' : 'ul';
                                html += `<${listTag}>`;
                                block.items.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</${listTag}>`;
                                break;
                            case 'image':
                                html += `<figure>`;
                                html += `<img src="${block.url}" alt="${block.alt || ''}" class="post-image">`;
                                if (block.caption) {
                                    html += `<figcaption>${block.caption}</figcaption>`;
                                }
                                html += `</figure>`;
                                break;
                            case 'delimiter':
                                html += '<hr>';
                                break;
                            default:
                                if (block.content) {
                                    html += `<div>${block.content}</div>`;
                                }
                        }
                    });
                } else if (contentObj.html) {
                    // html 필드가 있는 경우
                    html = contentObj.html;
                }
                
                // 생성된 HTML 삽입
                document.currentScript.insertAdjacentHTML('afterend', html);
                
            } catch (e) {
                // 오류 발생 시 콘솔에 로깅하고 안전하게 처리
                console.error('콘텐츠 파싱 오류:', e);
                
                // 안전한 대체 콘텐츠 표시
                document.currentScript.insertAdjacentHTML('afterend', 
                    `<p>콘텐츠를 표시하는 중 오류가 발생했습니다.</p>`);
            }
        </script>
        
        <!-- 스크립트 실패시 대체 콘텐츠 -->
        <noscript>
            <div class="noscript-content">
                {% if post.get_preview %}
                    {{ post.get_preview(9999)|safe }}
                {% else %}
                    {{ post.content|safe }}
                {% endif %}
            </div>
        </noscript>
    </div>
    
    {% if current_user.is_authenticated and current_user.id == post.user_id %}
        <div class="post-actions">
            <a href="{{ url_for('blog.edit', post_id=post.id) }}" class="btn">수정</a>
            <button class="btn btn-secondary" onclick="deletePost({{ post.id }})">삭제</button>
        </div>
    {% endif %}
</article>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/prism.min.js"></script>
<script>
    function deletePost(postId) {
        if (confirm('정말로 이 글을 삭제하시겠습니까?')) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            fetch(`/blog/posts/${postId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "{{ url_for('blog.index') }}";
                } else {
                    alert(data.message || '삭제에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('오류:', error);
                alert('서버 통신 중 오류가 발생했습니다.');
            });
        }
    }
    
    // 페이지 로드 후 코드 블록에 구문 강조 적용
    document.addEventListener('DOMContentLoaded', function() {
        const codeBlocks = document.querySelectorAll('pre code');
        codeBlocks.forEach(block => {
            Prism.highlightElement(block);
        });
    });
</script>
{% endblock %}